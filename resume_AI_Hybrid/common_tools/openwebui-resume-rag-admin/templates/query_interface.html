<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Query Interface - ChromaDB Admin (v3.0)</title>
    <!-- STATUS BOX VERSION - CACHE BUSTER -->
    <meta name="cache-version" content="statusbox-v3">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .query-card {
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 12px;
        }
        .query-input {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }
        .query-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }
        .result-card {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .source-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            transition: transform 0.2s ease;
        }
        .source-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .candidate-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 1rem;
            transition: transform 0.2s ease;
        }
        .candidate-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        .border-left-success {
            border-left: 4px solid #28a745 !important;
        }
        .border-left-warning {
            border-left: 4px solid #ffc107 !important;
        }
        .border-left-danger {
            border-left: 4px solid #dc3545 !important;
        }
        .score-badge {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
        }
        .badge-lg {
            font-size: 1rem;
            padding: 0.6rem 1.2rem;
        }
        .resume-link {
            text-decoration: none;
            font-weight: 600;
        }
        .resume-link:hover {
            text-decoration: underline;
        }
        .key-extracts {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
        }
        .key-extracts table td {
            border: none;
            padding: 0.3rem 0.5rem;
        }
        .resume-ranking-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .resume-title-with-score {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .score-inline {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
        }
        .justification-summary {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }
        .key-extracts-table .table {
            margin-bottom: 0;
        }
        .key-extracts-table .table th {
            background-color: #f8f9fa;
            border-top: none;
            font-weight: 600;
        }
        .extract-text {
            line-height: 1.4;
            font-size: 0.9rem;
        }
        .collection-results-header {
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .border-left-primary {
            border-left: 4px solid #007bff !important;
        }
        .breadcrumb-banner {
            background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #007bff;
            margin-bottom: 2rem;
        }
        .breadcrumb {
            background: transparent;
            margin-bottom: 0;
        }
        .breadcrumb-item.active {
            color: #007bff;
            font-weight: 600;
        }
        .loading-spinner {
            display: none;
        }
        .query-examples {
            background: #e7f3ff;
            border: 1px solid #b3d4fc;
            border-radius: 8px;
            padding: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('admin_dashboard') }}">
                <i class="fas fa-database"></i> ChromaDB Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('admin_dashboard') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('manage_collections') }}">Collections</a>
                <a class="nav-link" href="{{ url_for('manage_database') }}">Database</a>
                <a class="nav-link active" href="{{ url_for('query_interface') }}">Query</a>
                <a class="nav-link" href="{{ url_for('stats_viewer') }}">Statistics</a>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb Banner -->
    <div class="container mt-3">
        <div class="breadcrumb-banner p-3 rounded">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('admin_dashboard') }}"><i class="fas fa-home"></i> Dashboard</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        <i class="fas fa-search"></i> RAG Query Interface
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-search text-primary"></i> RAG Query Interface</h2>
                        <p class="text-muted">Query your resume database using Azure OpenAI LLM</p>
                        <!-- TEMPLATE VERSION CHECK -->
                        <div class="alert alert-warning mt-2">
                            <strong>ðŸ”§ TEMPLATE DEBUG:</strong> Version 3.0 - Modified Template Active
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary" onclick="showExamples()">
                            <i class="fas fa-question-circle"></i> Examples
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Query Examples (Hidden by default) -->
        <div id="queryExamples" class="query-examples mb-4" style="display: none;">
            <h6><i class="fas fa-lightbulb"></i> Example Queries</h6>
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2"><strong>General Questions:</strong></p>
                    <ul class="mb-3">
                        <li><code>What are Brandon's key technical skills?</code></li>
                        <li><code>Who has cybersecurity experience?</code></li>
                        <li><code>Find candidates with cloud computing skills</code></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <p class="mb-2"><strong>Ranking Queries:</strong></p>
                    <ul class="mb-3">
                        <li><code>Top 5 candidates for a cybersecurity role</code></li>
                        <li><code>Best candidates with Azure experience</code></li>
                        <li><code>Rank candidates by years of experience</code></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Query Form -->
        <div class="row">
            <div class="col-12">
                <div class="card query-card mb-4">
                    <div class="card-body p-4">
                        <form id="queryForm">
                            <!-- Collection Selection -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-folder"></i> Collection
                                    </label>
                                    <select class="form-select" id="collectionSelect" onchange="updateResumeCount()">
                                        <option value="">All Collections</option>
                                        {% for collection in collections %}
                                        <option value="{{ collection }}">{{ collection }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-cog"></i> Query Type
                                    </label>
                                    <select class="form-select" id="queryTypeSelect">
                                        <option value="standard">Standard Query</option>
                                        <option value="ranking">Ranked Candidates</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Model Selection -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-brain"></i> LLM Model
                                    </label>
                                    <select class="form-select" id="llmModelSelect">
                                        <option value="">Loading models...</option>
                                    </select>
                                    <div class="form-text">
                                        <small id="modelProviderInfo" class="text-muted">Select a model for query processing</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-sliders-h"></i> Temperature
                                    </label>
                                    <select class="form-select" id="temperatureSelect">
                                        <option value="0.1">0.1 - Very Focused</option>
                                        <option value="0.3">0.3 - Focused</option>
                                        <option value="0.5">0.5 - Balanced</option>
                                        <option value="0.7" selected>0.7 - Creative</option>
                                        <option value="0.9">0.9 - Very Creative</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Resume Count Status Box -->
                            <div class="row mb-3" id="statusRow" style="display: none;">
                                <div class="col-12">
                                    <div class="alert alert-info mb-3">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span id="statusText">Loading resume count...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- CACHE BUSTER - Status box should be visible above -->
                            <div class="row mb-2">
                                <div class="col-12">
                                    <small class="text-muted">Template Version: 3.0 - Status Box Active</small>
                                </div>
                            </div>

                            <!-- Max Results -->
                            <div class="row mb-3" id="maxResultsRow">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-list-ol"></i> Max Results
                                    </label>
                                    <select class="form-select" id="maxResults">
                                        <option value="3">Top 3</option>
                                        <option value="5" selected>Top 5</option>
                                        <option value="10">Top 10</option>
                                        <option value="15">Top 15</option>
                                        <option value="20">Top 20</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Query Input -->
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-comment-dots"></i> Your Question
                                </label>
                                <textarea class="form-control query-input" 
                                          id="queryText" 
                                          rows="4" 
                                          placeholder="e.g., What are Brandon's key skills and technical expertise?"></textarea>
                            </div>

                            <!-- Submit Button -->
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg px-5">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div class="row">
            <div class="col-12">
                <div class="loading-spinner text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Processing your query...</p>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div id="resultsContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showExamples() {
            const examples = document.getElementById('queryExamples');
            examples.style.display = examples.style.display === 'none' ? 'block' : 'none';
        }
        
        function loadAvailableModels() {
            fetch('/api/providers')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateLLMModels(data.providers.llm_providers);
                        // Set current selection from configuration
                        const currentConfig = data.providers.current_configuration;
                        if (currentConfig.llm_provider && currentConfig.llm_model) {
                            const llmSelect = document.getElementById('llmModelSelect');
                            const optionValue = `${currentConfig.llm_provider}:${currentConfig.llm_model}`;
                            llmSelect.value = optionValue;
                        }
                        if (currentConfig.temperature) {
                            document.getElementById('temperatureSelect').value = currentConfig.temperature;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading models:', error);
                    document.getElementById('llmModelSelect').innerHTML = '<option value="">Error loading models</option>';
                });
        }
        
        function populateLLMModels(llmProviders) {
            const llmSelect = document.getElementById('llmModelSelect');
            llmSelect.innerHTML = '<option value="">Select LLM Model...</option>';
            
            Object.keys(llmProviders).forEach(providerId => {
                const provider = llmProviders[providerId];
                if (provider.models && provider.models.length > 0) {
                    // Add optgroup for each provider
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = provider.display_name;
                    
                    provider.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = `${providerId}:${model}`;
                        option.textContent = model;
                        optgroup.appendChild(option);
                    });
                    
                    llmSelect.appendChild(optgroup);
                }
            });
            
            // Update model info when selection changes
            llmSelect.addEventListener('change', function() {
                const selectedValue = this.value;
                const infoElement = document.getElementById('modelProviderInfo');
                if (selectedValue) {
                    const [providerId, modelName] = selectedValue.split(':');
                    const provider = llmProviders[providerId];
                    infoElement.textContent = `${provider.display_name} - ${modelName}`;
                } else {
                    infoElement.textContent = 'Select a model for query processing';
                }
            });
        }

        async function updateResumeCount() {
            const collectionSelect = document.getElementById('collectionSelect');
            const selectedCollection = collectionSelect.value;
            const statusRow = document.getElementById('statusRow');
            const statusText = document.getElementById('statusText');
            
            if (!selectedCollection) {
                // All Collections selected
                try {
                    const response = await fetch('/api/database/stats');
                    const stats = await response.json();
                    
                    let totalResumes = 0;
                    let collectionNames = [];
                    
                    if (stats.collections) {
                        stats.collections.forEach(collStats => {
                            if (collStats.documents && typeof collStats.documents === 'number') {
                                totalResumes += collStats.documents;
                                collectionNames.push(collStats.name);
                            }
                        });
                    }
                    
                    statusText.innerHTML = `<strong>Search Scope:</strong> All Collections (${collectionNames.length} collections, ${totalResumes} total resumes)`;
                    statusRow.style.display = 'block';
                } catch (error) {
                    statusText.innerHTML = `<strong>Search Scope:</strong> All Collections (count unavailable)`;
                    statusRow.style.display = 'block';
                }
            } else {
                // Specific collection selected
                try {
                    const response = await fetch('/api/database/stats');
                    const stats = await response.json();
                    
                    let resumeCount = 0;
                    if (stats.collections) {
                        const collectionData = stats.collections.find(coll => coll.name === selectedCollection);
                        if (collectionData && typeof collectionData.documents === 'number') {
                            resumeCount = collectionData.documents;
                        }
                    }
                    
                    statusText.innerHTML = `<strong>Search Scope:</strong> Collection "${selectedCollection}" (${resumeCount} resumes)`;
                    statusRow.style.display = 'block';
                } catch (error) {
                    statusText.innerHTML = `<strong>Search Scope:</strong> Collection "${selectedCollection}" (count unavailable)`;
                    statusRow.style.display = 'block';
                }
            }
        }

        // Initialize resume count on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - Status box version v3.0');
            console.log('Status row element:', document.getElementById('statusRow'));
            console.log('Collection select element:', document.getElementById('collectionSelect'));
            
            // Force show status box for debugging
            const statusRow = document.getElementById('statusRow');
            if (statusRow) {
                console.log('Found status row, making it visible...');
                statusRow.style.display = 'block';
                document.getElementById('statusText').innerHTML = '<strong>Status Box Test:</strong> Template version 3.0 loaded successfully!';
            } else {
                console.error('Status row element not found!');
            }
            
            updateResumeCount();
            loadAvailableModels();
        });

        document.getElementById('queryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const queryText = document.getElementById('queryText').value.trim();
            if (!queryText) {
                alert('Please enter a question');
                return;
            }

            const collection = document.getElementById('collectionSelect').value || null;
            const queryType = document.getElementById('queryTypeSelect').value;
            const maxResults = document.getElementById('maxResults').value;
            const selectedModel = document.getElementById('llmModelSelect').value;
            const temperature = document.getElementById('temperatureSelect').value;

            // Show loading spinner
            document.querySelector('.loading-spinner').style.display = 'block';
            document.getElementById('resultsContainer').innerHTML = '';

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: queryText,
                        collection: collection,
                        query_type: queryType,
                        max_results: parseInt(maxResults),
                        model: selectedModel,
                        temperature: parseFloat(temperature)
                    })
                });

                const result = await response.json();

                // Hide loading spinner
                document.querySelector('.loading-spinner').style.display = 'none';

                if (result.success) {
                    if (result.query_type === 'ranking') {
                        displayRankingResults(result.results);
                    } else {
                        displayStandardResults(result);
                    }
                } else {
                    displayError(result.error);
                }
            } catch (error) {
                document.querySelector('.loading-spinner').style.display = 'none';
                displayError('Network error: ' + error.message);
            }
        });

        function displayStandardResults(result) {
            const container = document.getElementById('resultsContainer');
            
            if (!result.results || result.results.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> No results found.
                    </div>
                `;
                return;
            }

            let html = '';

            result.results.forEach((collectionResult) => {
                if (collectionResult.error) {
                    // Determine error type and styling
                    let errorClass = 'alert-danger';
                    let errorIcon = 'fas fa-exclamation-circle';
                    let helpText = '';
                    
                    if (collectionResult.error.includes('sentence_transformers') || 
                        collectionResult.error.includes('Missing dependency')) {
                        errorClass = 'alert-warning';
                        errorIcon = 'fas fa-download';
                        helpText = '<small class="d-block mt-2"><strong>Fix:</strong> Install the missing package by running <code>pip install sentence_transformers</code> in your terminal, then restart the application.</small>';
                    } else if (collectionResult.error.includes('langchain_huggingface')) {
                        errorClass = 'alert-warning';
                        errorIcon = 'fas fa-download';
                        helpText = '<small class="d-block mt-2"><strong>Fix:</strong> Install the missing package by running <code>pip install langchain_huggingface</code> in your terminal, then restart the application.</small>';
                    } else if (collectionResult.error.includes('Embedding') && collectionResult.error.includes('dependency')) {
                        errorClass = 'alert-warning';
                        errorIcon = 'fas fa-cogs';
                        helpText = '<small class="d-block mt-2"><strong>Fix:</strong> Check that all required embedding packages are installed and restart the application.</small>';
                    }
                    
                    html += `
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert ${errorClass}">
                                    <h6><i class="${errorIcon}"></i> Error in collection: ${collectionResult.collection}</h6>
                                    <p class="mb-0">${collectionResult.error}</p>
                                    ${helpText}
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                if (collectionResult.sources && collectionResult.sources.length > 0) {
                    // Check if this is enhanced scoring results
                    const hasScoring = collectionResult.response_type === 'enhanced_scoring' || 
                                     collectionResult.sources.some(s => s.hasOwnProperty('score'));
                    
                    if (hasScoring) {
                        // Enhanced scoring display - exact format requested
                        html += `
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="collection-results-header p-3 bg-light border-left-primary">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h4 class="mb-1"><i class="fas fa-trophy text-warning"></i> Resume Rankings</h4>
                                                <p class="text-muted mb-0">
                                                    <i class="fas fa-database"></i> Collection: <strong>${collectionResult.collection}</strong> | 
                                                    <i class="fas fa-users"></i> ${collectionResult.total_candidates || collectionResult.sources.length} candidates found | 
                                                    <i class="fas fa-sort-amount-down"></i> Ranked by relevance score (highest first)
                                                </p>
                                            </div>
                                            <button class="btn btn-success" onclick="exportToExcel('${collectionResult.collection}', ${JSON.stringify(collectionResult.sources).replace(/'/g, '&apos;')})">
                                                <i class="fas fa-file-excel"></i> Export to Excel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                        collectionResult.sources.forEach((candidate, index) => {
                            const score = candidate.score || 0;
                            const scoreColor = score >= 80 ? 'success' : score >= 60 ? 'warning' : 'danger';
                            
                            // Handle both new and legacy resume formats
                            const candidateName = candidate.candidate_name || 'Resume Candidate';
                            const displayTitle = candidate.display_title || candidate.original_title || candidate.original_filename;
                            const filePath = candidate.original_file_path || candidate.original_filename;
                            const sourceDescription = `${displayTitle}${candidate.chunk_count > 1 ? ` (${candidate.chunk_count} sections)` : ''}`;
                            
                            // Use the original_filename as the identifier for the resume viewer
                            const viewerIdentifier = candidate.original_filename;
                            
                            // Job tenure risk highlighting
                            const isFlightRisk = candidate.job_flight_risk === true;
                            const cardStyle = isFlightRisk ? 'border-left: 5px solid #ffc107; background-color: #fffbf0;' : '';
                            const currentJobMonths = candidate.current_job_months || 0;
                            const avgTenureMonths = candidate.average_job_tenure_months || 0;
                            
                            html += `
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="resume-ranking-card" style="${cardStyle}">
                                            <!-- Resume Title with Score on Same Line -->
                                            <h5 class="resume-title-with-score mb-2">
                                                <a href="#" class="resume-link text-primary" 
                                                   data-filename="${viewerIdentifier}" 
                                                   data-filepath="${filePath}"
                                                   data-collection="${candidate.collection}"
                                                   onclick="openResumeViewer('${viewerIdentifier}', '${candidate.collection}', '${filePath}')">
                                                    <i class="fas fa-user-tie"></i> ${candidateName}
                                                </a>
                                                <span class="score-inline badge badge-${scoreColor} ml-3">${score}/100</span>
                                            </h5>
                                            
                                            <!-- Justification Summary Under Title -->
                                            <div class="justification-summary mb-3">
                                                <p class="text-muted mb-0">
                                                    <strong>Ranking Justification:</strong> ${candidate.justification || 'No justification provided'}
                                                </p>
                                            </div>
                                            
                                            <!-- Key Extracts Table Under Justification -->
                                            ${candidate.key_extracts && candidate.key_extracts.length > 0 ? `
                                                <div class="key-extracts-table">
                                                    <h6 class="mb-2"><i class="fas fa-table text-info"></i> Key Extracts Contributing to Score:</h6>
                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-bordered">
                                                            <thead class="thead-light">
                                                                <tr>
                                                                    <th style="width: 60px;">#</th>
                                                                    <th>Extract from Resume</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                ${candidate.key_extracts.map((extract, i) => 
                                                                    `<tr>
                                                                        <td class="text-center font-weight-bold">${i + 1}</td>
                                                                        <td class="extract-text">${extract}</td>
                                                                    </tr>`
                                                                ).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            ` : '<p class="text-muted small">No key extracts identified</p>'}
                                            
                                            <hr class="my-3">
                                            
                                            <!-- Job Tenure Information -->
                                            ${currentJobMonths > 0 || avgTenureMonths > 0 ? `
                                                <div class="job-tenure-info mb-3 p-2 ${isFlightRisk ? 'bg-warning-light' : 'bg-light'} rounded">
                                                    <h6 class="mb-2">
                                                        <i class="fas fa-briefcase"></i> Job Tenure Analysis
                                                        ${isFlightRisk ? '<span class="badge badge-warning ml-2"><i class="fas fa-exclamation-triangle"></i> Flight Risk</span>' : ''}
                                                    </h6>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <small><strong>Current Job Duration:</strong> ${(currentJobMonths / 12).toFixed(1)} years (${currentJobMonths} months)</small>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <small><strong>Average Job Tenure:</strong> ${(avgTenureMonths / 12).toFixed(1)} years (${avgTenureMonths} months)</small>
                                                        </div>
                                                    </div>
                                                    ${isFlightRisk ? `
                                                        <div class="alert alert-warning mt-2 mb-0 py-2">
                                                            <small><i class="fas fa-info-circle"></i> <strong>Note:</strong> Current job duration is within 6 months of average tenure. Candidate may be considering new opportunities.</small>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            ` : ''}
                                            
                                            <!-- Metadata Footer -->
                                            <div class="candidate-metadata">
                                                <small class="text-muted">
                                                    <i class="fas fa-folder"></i> Collection: ${candidate.collection} | 
                                                    <i class="fas fa-file"></i> Source: ${sourceDescription}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        // Standard source display (legacy)
                    html += `
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="fas fa-file-alt text-info"></i> Source Documents from ${collectionResult.collection}</h6>
                            </div>
                        </div>
                        <div class="row mb-4">
                    `;

                    collectionResult.sources.forEach((doc, index) => {
                        // Use the cleaned display title from the backend
                        const originalName = doc.display_title || 
                                           doc.original_title ||
                                           doc.original_filename || 
                                           doc.metadata?.display_filename || 
                                           doc.metadata?.original_file_source?.split('\\').pop()?.split('/').pop() ||
                                           doc.metadata?.document_name || 
                                           'Unknown';
                        
                        // Show chunk count if multiple chunks were combined
                        const chunkInfo = doc.chunk_count > 1 ? ` (${doc.chunk_count} sections)` : '';
                        
                        html += `
                            <div class="col-md-4 mb-3">
                                <div class="source-card p-3 h-100">
                                    <h6><i class="fas fa-document text-primary"></i> Document ${index + 1}</h6>
                                    <p class="small text-muted mb-2">
                                        <strong>Source:</strong> ${originalName}${chunkInfo}<br>
                                        <strong>Collection:</strong> ${doc.collection}
                                    </p>
                                    <p class="small">${doc.content}</p>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    }
                }
            });

            // Add token usage table if available
            if (result.token_usage) {
                html += `
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-chart-bar text-info"></i> Token Usage Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Metric</th>
                                                    <th>Value</th>
                                                    <th>Details</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${result.token_usage.model_used ? `
                                                <tr class="bg-light">
                                                    <td><strong><i class="fas fa-robot text-primary"></i> Model Used</strong></td>
                                                    <td><span class="badge bg-primary">${result.token_usage.model_used}</span></td>
                                                    <td>LLM provider and model for this query</td>
                                                </tr>
                                                ` : ''}
                                                ${result.token_usage.temperature !== undefined ? `
                                                <tr>
                                                    <td><strong><i class="fas fa-thermometer-half text-warning"></i> Temperature</strong></td>
                                                    <td><span class="badge bg-warning text-dark">${result.token_usage.temperature}</span></td>
                                                    <td>Creativity/randomness setting (0.0-1.0)</td>
                                                </tr>
                                                ` : ''}
                                                ${result.token_usage.prompt_tokens ? `
                                                <tr>
                                                    <td><strong><i class="fas fa-arrow-up text-primary"></i> Tokens Sent</strong></td>
                                                    <td><span class="badge bg-primary">${result.token_usage.prompt_tokens}</span></td>
                                                    <td>Query + context sent to LLM</td>
                                                </tr>
                                                ` : ''}
                                                ${result.token_usage.completion_tokens ? `
                                                <tr>
                                                    <td><strong><i class="fas fa-arrow-down text-success"></i> Tokens Received</strong></td>
                                                    <td><span class="badge bg-success">${result.token_usage.completion_tokens}</span></td>
                                                    <td>Response generated by LLM</td>
                                                </tr>
                                                ` : ''}
                                                ${result.token_usage.total_tokens ? `
                                                <tr>
                                                    <td><strong><i class="fas fa-calculator text-info"></i> Total Tokens</strong></td>
                                                    <td><span class="badge bg-info">${result.token_usage.total_tokens}</span></td>
                                                    <td>Combined input and output tokens</td>
                                                </tr>
                                                ` : ''}
                                                ${result.token_usage.estimated_cost ? `
                                                <tr>
                                                    <td><strong><i class="fas fa-dollar-sign text-warning"></i> Estimated Cost</strong></td>
                                                    <td><span class="badge bg-warning text-dark">$${result.token_usage.estimated_cost.toFixed(4)}</span></td>
                                                    <td>Approximate cost based on LLM provider pricing</td>
                                                </tr>
                                                ` : ''}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function displayRankingResults(results) {
            const container = document.getElementById('resultsContainer');
            
            if (!results || results.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> No matching documents found.
                    </div>
                `;
                return;
            }

            let html = `
                <div class="row">
                    <div class="col-12">
                        <h4><i class="fas fa-trophy text-warning"></i> Ranked Documents</h4>
                        <p class="text-muted mb-4">Found ${results.length} relevant documents, ranked by relevance</p>
                    </div>
                </div>
                <div class="row">
            `;

            results.forEach((doc, index) => {
                const scorePercentage = Math.max(0, Math.min(100, (1 - doc.score) * 100)); // Convert distance to percentage
                const scoreClass = scorePercentage >= 80 ? 'score-high' : 
                                 scorePercentage >= 60 ? 'score-medium' : 'score-low';
                const rankIcon = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : `${index + 1}.`;
                
                const originalName = doc.original_filename || 
                                   doc.metadata?.display_filename || 
                                   doc.metadata?.original_file_source?.split('\\').pop()?.split('/').pop() ||
                                   doc.metadata?.document_name || 
                                   'Unknown';
                
                const chunkInfo = doc.chunk_count > 1 ? ` (${doc.chunk_count} chunks)` : '';

                html += `
                    <div class="col-12 mb-4">
                        <div class="candidate-card p-4">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center mb-3">
                                        <span class="h4 me-3">${rankIcon}</span>
                                        <div>
                                            <h5 class="mb-1">${originalName}${chunkInfo}</h5>
                                            <p class="text-muted mb-0">Collection: ${doc.collection}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="document-content">
                                        <p>${doc.content}</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center mb-3">
                                        <div class="score-badge ${scoreClass}">
                                            ${scorePercentage.toFixed(1)}%
                                        </div>
                                        <small class="text-muted d-block">Relevance Score</small>
                                    </div>
                                    
                                    <div class="small text-muted">
                                        <p><strong>Distance:</strong> ${doc.score.toFixed(4)}</p>
                                        <p><strong>Collection:</strong> ${doc.collection}</p>
                                        ${doc.chunk_count ? `<p><strong>Chunks Combined:</strong> ${doc.chunk_count}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function displayError(error) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> ${error}
                </div>
            `;
        }

        function openResumeViewer(filename, collection, filepath) {
            // Open resume content in a new window, using filepath if available
            const targetFile = filepath && filepath !== 'undefined' ? filepath : filename;
            const url = `/view_resume?filename=${encodeURIComponent(filename)}&collection=${encodeURIComponent(collection)}&filepath=${encodeURIComponent(targetFile)}`;
            window.open(url, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
        }

        async function exportToExcel(collection, sources) {
            try {
                const queryText = document.getElementById('queryText').value;
                
                const response = await fetch('/api/export_query_results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        collection: collection,
                        query: queryText,
                        results: sources
                    })
                });

                if (response.ok) {
                    // Download the file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `query_results_${collection}_${new Date().getTime()}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const error = await response.json();
                    alert('Export failed: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed: ' + error.message);
            }
        }
    </script>
</body>
</html>