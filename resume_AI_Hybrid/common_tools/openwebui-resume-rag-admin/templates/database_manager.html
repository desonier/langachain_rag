<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Manager - ChromaDB Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .breadcrumb-banner {
            background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #28a745;
            margin-bottom: 2rem;
        }
        .breadcrumb {
            background: transparent;
            margin-bottom: 0;
        }
        .breadcrumb-item.active {
            color: #28a745;
            font-weight: 600;
        }
        .hero-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .database-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .database-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-connected {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }
        .status-disconnected {
            background-color: #dc3545;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .danger-zone {
            border: 2px solid #dc3545;
            border-radius: 8px;
            background: #fff5f5;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('admin_dashboard') }}">
                <i class="fas fa-database"></i> ChromaDB Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a class="nav-link" href="{{ url_for('manage_collections') }}">
                    <i class="fas fa-folder"></i> Collections
                </a>
                <a class="nav-link active" href="{{ url_for('manage_database') }}">
                    <i class="fas fa-database"></i> Database
                </a>
                <a class="nav-link" href="{{ url_for('stats_viewer') }}">
                    <i class="fas fa-chart-bar"></i> Statistics
                </a>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb Banner -->
    <div class="container mt-3">
        <div class="breadcrumb-banner p-3 rounded">
            <div class="d-flex justify-content-between align-items-center">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('admin_dashboard') }}">
                                <i class="fas fa-home"></i> Dashboard
                            </a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">
                            <i class="fas fa-database"></i> Database Manager
                        </li>
                    </ol>
                </nav>
                <div class="d-flex align-items-center">
                    <span class="status-indicator status-connected" id="dbStatusIndicator"></span>
                    <span class="badge bg-success me-2" id="dbStatusBadge">
                        <i class="fas fa-server"></i> Connected
                    </span>
                    <button class="btn btn-outline-success btn-sm" onclick="checkDatabaseHealth()">
                        <i class="fas fa-heartbeat"></i> Health Check
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Hero Header -->
        <div class="hero-header p-5 text-center">
            <div class="row align-items-center">
                <div class="col-md-8 mx-auto">
                    <i class="fas fa-server feature-icon"></i>
                    <h1 class="display-5 fw-bold mb-3">Database Manager</h1>
                    <p class="lead mb-4">
                        Initialize, backup, restore, and maintain your ChromaDB database. 
                        Monitor database health and perform administrative operations.
                    </p>
                    <div class="d-flex justify-content-center gap-3">
                        <button class="btn btn-light btn-lg" onclick="checkDatabaseHealth()">
                            <i class="fas fa-stethoscope"></i> Health Check
                        </button>
                        <button class="btn btn-outline-light btn-lg" onclick="initializeDatabase()">
                            <i class="fas fa-play"></i> Initialize DB
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }}"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <!-- Database Operations -->
            <div class="col-md-8">
                <div class="card database-card shadow">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0"><i class="fas fa-tools"></i> Database Operations</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Initialize Database -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-play fa-2x text-success mb-3"></i>
                                        <h5 class="card-title">Initialize Database</h5>
                                        <p class="card-text">Set up a new ChromaDB instance or reinitialize existing database.</p>
                                        <button class="btn btn-success" onclick="initializeDatabase()">
                                            <i class="fas fa-play"></i> Initialize
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Backup Database -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-download fa-2x text-primary mb-3"></i>
                                        <h5 class="card-title">Backup Database</h5>
                                        <p class="card-text">Create a backup of all collections and their data.</p>
                                        <button class="btn btn-primary" onclick="backupDatabase()">
                                            <i class="fas fa-download"></i> Backup
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Restore Database -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-upload fa-2x text-info mb-3"></i>
                                        <h5 class="card-title">Restore Database</h5>
                                        <p class="card-text">Restore database from a previously created backup file.</p>
                                        <button class="btn btn-info text-white" onclick="restoreDatabase()">
                                            <i class="fas fa-upload"></i> Restore
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Health Check -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-heartbeat fa-2x text-warning mb-3"></i>
                                        <h5 class="card-title">Health Check</h5>
                                        <p class="card-text">Verify database connectivity and performance metrics.</p>
                                        <button class="btn btn-warning" onclick="checkDatabaseHealth()">
                                            <i class="fas fa-stethoscope"></i> Check Health
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="card database-card shadow mt-4 danger-zone">
                    <div class="card-header bg-danger text-white">
                        <h4 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Danger Zone</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <i class="fas fa-skull-crossbones"></i>
                            <strong>Warning:</strong> These operations are irreversible and will permanently affect your database!
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card border-warning">
                                    <div class="card-body text-center">
                                        <i class="fas fa-broom fa-2x text-warning mb-3"></i>
                                        <h6 class="card-title">Clear All Collections</h6>
                                        <p class="card-text small">Remove all documents from all collections.</p>
                                        <button class="btn btn-warning btn-sm" onclick="clearAllCollections()">
                                            <i class="fas fa-broom"></i> Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-danger">
                                    <div class="card-body text-center">
                                        <i class="fas fa-trash fa-2x text-danger mb-3"></i>
                                        <h6 class="card-title">Reset Database</h6>
                                        <p class="card-text small">Delete all collections and data completely.</p>
                                        <button class="btn btn-danger btn-sm" onclick="resetDatabase()">
                                            <i class="fas fa-trash"></i> Reset DB
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Information -->
            <div class="col-md-4">
                <div class="card database-card shadow">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Database Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Connection Status</h6>
                            <div class="d-flex align-items-center" id="connectionStatus">
                                <span class="status-indicator status-connected"></span>
                                <span class="text-success">Connected</span>
                            </div>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Database Path</h6>
                            <small class="text-break" id="databasePath">Loading...</small>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Statistics</h6>
                            <div class="row text-center">
                                <div class="col-6">
                                    <small class="text-muted">Collections</small>
                                    <div class="fw-bold" id="totalCollections">-</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Documents</small>
                                    <div class="fw-bold" id="totalDocuments">-</div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Last Operations</h6>
                            <div id="lastOperations">
                                <small class="text-muted">No recent operations</small>
                            </div>
                        </div>

                        <hr>

                        <div class="d-grid gap-2">
                            <a href="{{ url_for('manage_collections') }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-cogs"></i> Manage Collections
                            </a>
                            <a href="{{ url_for('stats_viewer') }}" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-chart-bar"></i> View Statistics
                            </a>
                            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-home"></i> Dashboard
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card database-card shadow mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="checkDatabaseHealth()">
                                <i class="fas fa-heartbeat"></i> Health Check
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshDatabaseInfo()">
                                <i class="fas fa-sync-alt"></i> Refresh Info
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="optimizeDatabase()">
                                <i class="fas fa-wrench"></i> Optimize
                            </button>
                        </div>
                        <hr>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Auto-refresh every 60 seconds
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">
                        <i class="fas fa-exclamation-triangle text-warning"></i> Confirm Action
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    Are you sure you want to perform this action?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn" onclick="executeConfirmedAction()">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Upload Modal for Restore -->
    <div class="modal fade" id="restoreModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-upload"></i> Restore Database
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="restoreForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="backupFile" class="form-label">Select Backup File</label>
                            <input type="file" class="form-control" id="backupFile" accept=".zip,.json,.db">
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> 
                                Supported formats: ZIP, JSON, DB files
                            </div>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Warning:</strong> This will overwrite your current database!
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" onclick="performRestore()">
                        <i class="fas fa-upload"></i> Restore Database
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let pendingAction = null;

        // Database operation functions
        function checkDatabaseHealth() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            btn.disabled = true;

            fetch('/api/database/health')
                .then(response => response.json())
                .then(data => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    
                    if (data.success) {
                        updateDatabaseStatus(data.healthy);
                        const healthScore = data.health_score || 0;
                        const message = data.healthy ? 
                            `Database health check passed! Score: ${healthScore.toFixed(1)}%` :
                            `Database health issues detected. Score: ${healthScore.toFixed(1)}%`;
                        showToast(message, data.healthy ? 'success' : 'warning');
                    } else {
                        updateDatabaseStatus(false);
                        showToast(`Health check failed: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    updateDatabaseStatus(false);
                    showToast(`Health check error: ${error.message}`, 'danger');
                });
        }

        function initializeDatabase() {
            pendingAction = 'initialize';
            
            document.getElementById('confirmModalTitle').innerHTML = '<i class="fas fa-play text-success"></i> Initialize Database';
            document.getElementById('confirmModalBody').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Initialize Database:</strong> This will set up a new ChromaDB instance.
                </div>
                <p>Are you sure you want to initialize the database?</p>
                <p class="text-muted">
                    <i class="fas fa-info-circle"></i> 
                    This is safe if you're setting up for the first time.
                </p>
            `;
            document.getElementById('confirmActionBtn').className = 'btn btn-success';
            document.getElementById('confirmActionBtn').innerHTML = '<i class="fas fa-play"></i> Initialize';
            
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }

        function backupDatabase() {
            showToast('Database backup feature coming soon!', 'info');
        }

        function restoreDatabase() {
            showToast('Database restore feature coming soon!', 'info');
        }

        function clearAllCollections() {
            pendingAction = 'clear_all';
            
            document.getElementById('confirmModalTitle').innerHTML = '<i class="fas fa-broom text-warning"></i> Clear All Collections';
            document.getElementById('confirmModalBody').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This will remove all documents from all collections.
                </div>
                <p>Are you sure you want to clear all collections?</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>All document data will be lost!</strong>
                </p>
            `;
            document.getElementById('confirmActionBtn').className = 'btn btn-warning';
            document.getElementById('confirmActionBtn').innerHTML = '<i class="fas fa-broom"></i> Clear All';
            
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }

        function resetDatabase() {
            pendingAction = 'reset';
            
            document.getElementById('confirmModalTitle').innerHTML = '<i class="fas fa-trash text-danger"></i> Reset Database';
            document.getElementById('confirmModalBody').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-skull-crossbones"></i>
                    <strong>Danger:</strong> This action cannot be undone!
                </div>
                <p>Are you sure you want to completely reset the database?</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>ALL DATA WILL BE PERMANENTLY LOST!</strong>
                </p>
            `;
            document.getElementById('confirmActionBtn').className = 'btn btn-danger';
            document.getElementById('confirmActionBtn').innerHTML = '<i class="fas fa-trash"></i> Reset Database';
            
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }

        function optimizeDatabase() {
            showToast('Database optimization feature coming soon!', 'info');
        }

        function executeConfirmedAction() {
            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
            
            const apiEndpoints = {
                'initialize': '/api/database/create',
                'clear_all': '/api/database/clear-all',
                'reset': '/api/database/reset'
            };
            
            const endpoint = apiEndpoints[pendingAction];
            if (!endpoint) {
                showToast('Unknown action', 'danger');
                return;
            }
            
            const actionMessages = {
                'initialize': 'Initializing database...',
                'clear_all': 'Clearing all collections...',
                'reset': 'Resetting database...'
            };
            
            showToast(actionMessages[pendingAction], 'info');
            
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        refreshDatabaseInfo();
                    }, 1000);
                } else {
                    showToast(data.error || data.message || 'Operation failed', 'danger');
                }
            })
            .catch(error => {
                showToast(`Operation failed: ${error.message}`, 'danger');
            });
            
            pendingAction = null;
        }

        function updateDatabaseStatus(connected) {
            const statusIndicator = document.getElementById('dbStatusIndicator');
            const statusBadge = document.getElementById('dbStatusBadge');
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (connected) {
                statusIndicator.className = 'status-indicator status-connected';
                statusBadge.innerHTML = '<i class="fas fa-server"></i> Connected';
                statusBadge.className = 'badge bg-success me-2';
                connectionStatus.innerHTML = `
                    <span class="status-indicator status-connected"></span>
                    <span class="text-success">Connected</span>
                `;
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Disconnected';
                statusBadge.className = 'badge bg-danger me-2';
                connectionStatus.innerHTML = `
                    <span class="status-indicator status-disconnected"></span>
                    <span class="text-danger">Disconnected</span>
                `;
            }
        }

        function refreshDatabaseInfo() {
            // Fetch real database statistics
            fetch('/api/database/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // Handle error case
                        document.getElementById('databasePath').textContent = data.database_path || 'Unknown';
                        document.getElementById('totalCollections').textContent = '-';
                        document.getElementById('totalDocuments').textContent = '-';
                        document.getElementById('lastOperations').innerHTML = `
                            <small class="text-danger">
                                <i class="fas fa-exclamation-triangle"></i> Error: ${data.error}
                            </small>
                        `;
                        updateDatabaseStatus(false);
                    } else {
                        // Update with real data
                        document.getElementById('databasePath').textContent = data.database_path || 'Unknown';
                        document.getElementById('totalCollections').textContent = data.total_collections || 0;
                        document.getElementById('totalDocuments').textContent = data.total_items || 0;
                        
                        // Update last operations
                        const lastUpdated = data.last_updated ? new Date(data.last_updated).toLocaleString() : 'Never';
                        document.getElementById('lastOperations').innerHTML = `
                            <small class="text-muted">
                                <div>âœ“ Statistics updated - ${lastUpdated}</div>
                                <div>ðŸ“Š Database size: ${data.database_size || 'Unknown'}</div>
                            </small>
                        `;
                        updateDatabaseStatus(true);
                    }
                })
                .catch(error => {
                    console.error('Error fetching database info:', error);
                    document.getElementById('lastOperations').innerHTML = `
                        <small class="text-danger">
                            <i class="fas fa-exclamation-triangle"></i> Connection error
                        </small>
                    `;
                    updateDatabaseStatus(false);
                });
        }

        function showToast(message, type) {
            // Create and show a toast notification
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.appendChild(toast);
            new bootstrap.Toast(toast).show();
            
            // Remove toast after it's hidden
            setTimeout(() => toast.remove(), 5000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateDatabaseStatus(true);
            refreshDatabaseInfo();
        });

        // Auto-refresh database info every 60 seconds
        setInterval(refreshDatabaseInfo, 60000);
    </script>
</body>
</html>